<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.css"
        integrity="sha256-IvM9nJf/b5l2RoebiFno92E5ONttVyaEEsdemDC6iQA=" crossorigin="anonymous" />
    <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.0/ajv.bundle.js"
        integrity="sha256-u9xr+ZJ5hmZtcwoxwW8oqA5+MIkBpIp3M2a4AgRNH1o=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.0/ajv.min.js"
        integrity="sha256-QZBaIVRF3ZHdyLzzW3WQQ5kVlqYeAgx4ccOv4ph/e/E=" crossorigin="anonymous"></script>
    <script src="libraries/xmlToJson-master/xmlToJson.js"></script>
    <script src="libraries/xml.js-master/xmllint.js"></script>


    <title>Anime Statistics</title>
    <style>
        body {
            padding: 0;
            margin: 0;
            height: 100vh;
            overflow-y: hidden;
        }

        #animeStatistics {
            display: none;
            width: 100vw;
            height: 1000px;
        }

        #arrowDownButton {
            width: 100px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #topAnimeGraph {
            max-width: 90%;
            margin-bottom: 5%;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }

        #topAnimeChart {
            display: block;
            height: 100vh;
        }

        #genderChart {
            width: 500px;
            height: 500px;
        }

        #genderComparisonChart {
            /* width: 500px; */
            /* height: 100%; */
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="topAnimeChart">
        <canvas id="topAnimeGraph"></canvas>
    </div>

    <div id="animeStatistics">
        <div>
            <img src="media/Arrow-down.svg" alt="Arrow Down" id="arrowDownButton">
        </div>
        <div id="genderChart">
            <canvas id="genderComparisonChart"></canvas>
        </div>

    </div>
    <!-- Random number generator, Used for testing -->
    <script>
        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
    </script>
    <!-- Main menu top anime Graph. -->
    <script>
        /**
         *
         * Main menu graph top anime graph.
         *
         */
        var ctx = document.getElementById("topAnimeGraph").getContext('2d');


        mainMenuTopAnimeChart();

        function mainMenuTopAnimeChart(dataTagsArray) {
            console.log("dataTags: ", dataTagsArray);
            var mainMenuTopAnimeNames = [];
            var mainMenuTopAnimeViews = [];
            var mainMenuTopAnimeIds = [];
            var mainMenuTopAnimeRatings = [];

            var promise = Promise.resolve();
            $.each(dataTagsArray, function (k, i) {
                promise = promise.then(function () {
                    myChart.update();
                    mainMenuTopAnimeNames[k] = i.name;
                    mainMenuTopAnimeViews[k] = i.views;
                    mainMenuTopAnimeIds[k] = i.id;
                    mainMenuTopAnimeRatings[k] = i.rating;
                    return new Promise(function (resolve) {
                        setTimeout(resolve, 150);
                    });
                });
            });


            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: mainMenuTopAnimeNames,
                    datasets: [
                        // {
                        //     type: "line",
                        //     label: 'Rating',
                        //     fill: false,
                        //     backgroundColor: 'rgb(255, 99, 132)',
                        //     borderColor: 'rgb(255, 99, 132)',
                        //     data: mainMenuTopAnimeRatings,
                        //     yAxisID: 'right-y-axis',

                        // },
                        // {
                        //     type: "bar",
                        //     label: 'Male',
                        //     fill: false,
                        //     backgroundColor: 'rgb(255, 99, 132)',
                        //     borderColor: 'rgb(255, 99, 132)',
                        //     data: mainMenuTopAnimeTotalEpisodes,
                        //     xAxisID: 'views-x-axis',
                        //     yAxisID: 'views-y-axis',


                        // },

                        // {
                        //     label: 'Episodes',
                        //     data: mainMenuTopAnimeTotalEpisodes,
                        //     backgroundColor: 'rgba(107, 196, 255, 1)',
                        //     borderColor: 'rgba(0, 138, 230, 1)',
                        // },
                        {
                            label: 'Rating',
                            type: "line",
                            data: mainMenuTopAnimeRatings,

                            borderWidth: 2,
                            // maxBarThickness: 200,
                            // xAxisID: 'views-x-axis',
                            yAxisID: 'right-y-axis',
                            fill: false,
                            pointHoverRadius: 8,
                            pointRadius: 5,
                            backgroundColor: 'rgb(201, 22, 60)',
                            borderColor: 'rgb(255, 99, 132)',


                        },
                        {
                            label: 'Views',
                            data: mainMenuTopAnimeViews,
                            backgroundColor: 'rgba(50, 180, 227)',
                            borderColor: 'rgba(0, 138, 230, 1)',
                        },
                        {
                            label: 'animeId',
                            data: mainMenuTopAnimeIds,
                            hidden: true,

                        }
                    ]
                },
                options: {
                    legend: {
                        labels: {
                            filter: function (item, chart) {
                                // Remove legend item.
                                return !item.text.includes('animeId');
                            },

                        }
                    },
                    scales: {
                        xAxes: [{
                            stacked: true,
                            id: 'views-x-axis',
                            ticks: {
                                fontSize: 14,
                            }
                        }
                        ],
                        yAxes: [{
                            stacked: true,
                            id: 'views-y-axis',
                            type: 'linear',
                            position: 'left',
                            ticks: {
                                // suggestedMax: 10,
                                suggestedMin: 0,
                                stepSize: 100
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Views',
                                fontSize: 24,
                            },
                        }, {
                            type: 'linear',
                            id: 'right-y-axis',
                            display: true,
                            position: 'right',
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Rating',
                                fontSize: 28,
                            },
                            gridLines: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                suggestedMax: 10,
                                // suggestedMin: 9,
                                stepSize: 1
                            }
                        }]
                    }
                },
            })
        }
    </script>
    <!-- <script>
        function animeUsersStatsGraph(dataTagsArray) {
            console.log("dataTags: ", dataTagsArray);
            // var mainMenuTopAnimeNames = [];
            // var mainMenuTopAnimeViews = [];
            // var mainMenuTopAnimeIds = [];
            // var mainMenuTopAnimeRatings = [];
            var animeUserStatsGraphUserIds= [];
            var animeUserStatsGraph= [];
            var animeUserStatsGraph= [];
            var animeUserStatsGraph= [];
            var animeUserStatsGraph= [];
            var animeUserStatsGraph= [];
            var animeUserStatsGraph= [];
            var promise = Promise.resolve();
            $.each(dataTagsArray, function (k, i) {
                promise = promise.then(function () {
                    myChart.update();
                    mainMenuTopAnimeNames[k] = i.name;
                    mainMenuTopAnimeViews[k] = i.views;
                    mainMenuTopAnimeIds[k] = i.id;
                    mainMenuTopAnimeRatings[k] = i.rating;
                    return new Promise(function (resolve) {
                        setTimeout(resolve, 150);
                    });
                });
            });


            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: mainMenuTopAnimeNames,
                    datasets: [
                        // {
                        //     type: "line",
                        //     label: 'Rating',
                        //     fill: false,
                        //     backgroundColor: 'rgb(255, 99, 132)',
                        //     borderColor: 'rgb(255, 99, 132)',
                        //     data: mainMenuTopAnimeRatings,
                        //     yAxisID: 'right-y-axis',

                        // },
                        // {
                        //     type: "bar",
                        //     label: 'Male',
                        //     fill: false,
                        //     backgroundColor: 'rgb(255, 99, 132)',
                        //     borderColor: 'rgb(255, 99, 132)',
                        //     data: mainMenuTopAnimeTotalEpisodes,
                        //     xAxisID: 'views-x-axis',
                        //     yAxisID: 'views-y-axis',


                        // },

                        // {
                        //     label: 'Episodes',
                        //     data: mainMenuTopAnimeTotalEpisodes,
                        //     backgroundColor: 'rgba(107, 196, 255, 1)',
                        //     borderColor: 'rgba(0, 138, 230, 1)',
                        // },
                        {
                            label: 'Rating',
                            type: "line",
                            data: mainMenuTopAnimeRatings,

                            borderWidth: 2,
                            // maxBarThickness: 200,
                            // xAxisID: 'views-x-axis',
                            yAxisID: 'right-y-axis',
                            fill: false,
                            pointHoverRadius: 8,
                            pointRadius: 5,
                            backgroundColor: 'rgb(201, 22, 60)',
                            borderColor: 'rgb(255, 99, 132)',


                        },
                        {
                            type: "line",
                            label: 'Views',
                            data: mainMenuTopAnimeViews,
                            backgroundColor: 'rgba(50, 180, 227)',
                            borderColor: 'rgba(0, 138, 230, 1)',
                        },
                        {
                            type: "line",
                            label: 'animeId',
                            data: mainMenuTopAnimeIds,
                            // hidden: true,

                        }
                    ]
                },
                options: {
                    legend: {
                        labels: {
                            // filter: function (item, chart) {
                            //     // Remove legend item.
                            //     return !item.text.includes('animeId');
                            // },

                        }
                    },
                    scales: {
                        xAxes: [{
                            stacked: true,
                            id: 'views-x-axis',
                            ticks: {
                                fontSize: 14,
                            }
                        }
                        ],
                        yAxes: [{
                            stacked: true,
                            id: 'views-y-axis',
                            type: 'linear',
                            position: 'left',
                            ticks: {
                                // suggestedMax: 10,
                                suggestedMin: 0,
                                stepSize: 100
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Views',
                                fontSize: 24,
                            },
                        }, {
                            type: 'linear',
                            id: 'right-y-axis',
                            display: true,
                            position: 'right',
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Rating',
                                fontSize: 28,
                            },
                            gridLines: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                suggestedMax: 10,
                                // suggestedMin: 9,
                                stepSize: 1
                            }
                        }]
                    }
                },
            })
        }
    </script> -->
    <!-- Anime stats page Doughnut -->
    <script>
        var genderAnimeChartMales = 0;
        var genderAnimeChartFemales = 0;
        var ctxDoughnut = document.getElementById("genderComparisonChart").getContext('2d');
        var genderComparisonChart = new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: ['Male', 'Female'],
                datasets: [{
                    label: '',
                    data: [genderAnimeChartMales, genderAnimeChartFemales],
                    backgroundColor: [
                        'rgba(6, 155, 209)',
                        'rgba(249, 191, 203)',
                    ],
                    borderColor: [
                        'rgba(6, 121, 209)',
                        'rgba(245, 144, 165)',
                    ],
                    borderWidth: 3
                }]
            },
            options: {
                //cutoutPercentage: 40,
                responsive: true,

            }
        });
        // genderAnimeChart();
        function genderAnimeChart(dataTagsArray) {

            // genderComparisonChart.data.labels.pop();
            genderComparisonChart.data.datasets.forEach((dataset) => {
                // console.log(data);
                dataset.data.pop();
                dataset.data.pop();
            });
            console.log("DataTagArray: ", dataTagsArray);
            // genderComparisonChart.data.labels.push(label);
            // genderComparisonChart.data.labels.push(label);
            // console.log("XML array", dataTagsArray);
            // console.log("LINE 323 FIXEN DAT DIT OOK MET XML WERKT ZOALS MAIN GRAPH.!!!!!!!!!!!!!1");
            genderComparisonChart.data.datasets.forEach((dataset) => {
                dataset.data.push(dataTagsArray[0].male);
                dataset.data.push(dataTagsArray[0].female);
            });
            genderComparisonChart.update();
            chartset = true;


        }



    </script>
    <!-- Click event handler for main top anime chart. -->
    <script>
        /**
         * 
         * Click event handler main top anime chart.
         * 
         */
        document.getElementById("topAnimeGraph").onclick = function (evt) {
            var activePoints = myChart.getElementsAtEventForMode(evt, 'point', myChart.options);
            var firstPoint = activePoints[0];
            //Check of click wel op een bar was.
            if (firstPoint == undefined) { return; }

            var label = myChart.data.labels[firstPoint._index];
            var value = myChart.data.datasets[firstPoint._datasetIndex].data[firstPoint._index];
            console.log("Label: " + label + ": " + value);
            // console.log(myChart.data.datasets[firstPoint._datasetIndex]);
            // console.log(myChart.data.datasets);
            // console.log(activePoints[0]._index);
            triggerSlideStats();
            var selectedAnimeId = myChart.data.datasets[2].data[activePoints[0]._index];
            getGenderComparisonData(selectedAnimeId);
            getAnimeUsersStats(selectedAnimeId);
            console.log("Clicked Anime ID: ", myChart.data.datasets[2].data[activePoints[0]._index]);
            // console.log(activePoints[0]._index);
        };
    </script>
    <!-- Script for anime Stats panel. -->
    <script>
        $("#arrowDownButton").click(function () {
            triggerSlideStats();
        })
        function triggerSlideStats() {
            if ($("#animeStatistics").first().is(":hidden")) {

                $("#animeStatistics").slideDown("slow");
                $("#topAnimeChart").slideUp("slow");
                // $("#topAnimeChart").hide();
            } else {
                $("#topAnimeChart").slideDown(600);
                setTimeout(() => {
                    $("#animeStatistics").hide();
                }, 600);

            }
        }

    </script>

    <!-- Scripts for getting data. -->
    <script>
        var contentType = "json";
        var ajv = new Ajv({ coerceTypes: 'array' });

        /**
         * 
         * This section retrieves all json data from the API.
         * 
         *  
        */
        //Retrieve Top anime data
        getTopAnimeData();
        function getTopAnimeData() {
            $.ajax({
                url: "http://localhost/dataprocessing/api/v1/topanimes/10",
                type: 'GET',
                contentType: `application/${contentType}`,
                success: function (data, status, xhr) {
                    var schemaLocation = null;
                    var retrievedDataValidatable = data;
                    var retrievedData = data;
                    if (contentType === 'xml') {
                        retrievedDataValidatable = (new XMLSerializer()).serializeToString(retrievedData);
                        var parsedRetrievedData = xmlToJson.parse(data);
                        retrievedData = Object.entries(Object.entries(parsedRetrievedData)[0][1])[2][1];
                        schemaLocation = Object.entries(Object.entries(parsedRetrievedData)[0][1])[1][1];

                    }
                    else if (contentType === 'json') {
                        schemaLocation = xhr.getResponseHeader('Link');
                    }
                    //The tags that need to be retrieved.
                    var keyNameArray = ['name', 'views', 'id', 'rating', 'episodes'];

                    //Main logic of calling the functions.
                    executeGenderChartFunctions();
                    async function executeGenderChartFunctions() {
                        await validation(retrievedDataValidatable, await getSchema(schemaLocation));
                        await mainMenuTopAnimeChart(await convertJSONtoGraphData(retrievedData, keyNameArray));
                    }
                },
            })
        }

        function getGenderComparisonData(animeId) {
            $.ajax({
                url: `http://localhost/dataprocessing/api/v1/gendercomparison/${animeId}`,
                type: 'GET',
                contentType: `application/${contentType}`,
                success: function (data, status, xhr) {
                    var schemaGenderLocation = null;
                    var retrievedGenderData = data;
                    var retrievedGenderDataValidatable = data;
                    if (contentType === 'xml') {
                        retrievedGenderData = data;
                        retrievedGenderData2 = data;
                        //Add temp node so parsing goes right.
                        newNode = retrievedGenderData.createElement("gendersDifference");

                        retrievedGenderDataValidatable = (new XMLSerializer()).serializeToString(retrievedGenderData);
                        retrievedGenderData2.getElementsByTagName("root")[0].appendChild(newNode);
                        var parsedRetrievedGenderData = xmlToJson.parse(retrievedGenderData2);
                        parsedRetrievedGenderData.root.gendersDifference.pop();
                        // retrievedGenderData = parsedRetrievedGenderData;
                        retrievedGenderData = Object.entries(Object.entries(parsedRetrievedGenderData)[0][1])[2][1];
                        // console.log("ParsedDate: ", Object.entries(Object.entries(parsedRetrievedGenderData)[0][1])[2][1]);
                        schemaGenderLocation = Object.entries(Object.entries(parsedRetrievedGenderData)[0][1])[1][1];

                    }
                    else if (contentType === 'json') {
                        schemaGenderLocation = xhr.getResponseHeader('Link');
                    }
                    //The tags that need to be retrieved.
                    var keyNameArray = ['totalViewers', 'male', 'female'];
                    //Main logic of calling the functions.
                    executeChartFunctions();
                    async function executeChartFunctions() {

                        var validatedData = await validation(retrievedGenderDataValidatable, await getSchema(schemaGenderLocation));
                        await genderAnimeChart(await convertJSONtoGraphData(retrievedGenderData, keyNameArray));

                    }
                },
            })
        }

        function getAnimeUsersStats(animeId) {
            // $.ajax({
            //     url: `http://localhost/dataprocessing/api/v1/animeuserstatistics/${animeId}`,
            //     type: 'GET',
            //     contentType: `application/${contentType}`,
            //     success: function (data, status, xhr) {
            //         var schemaLocation = null;
            //         if (contentType === 'xml') {
            //             retrievedData = data;
            //             console.log("DATA: ", retrievedData);
            //             retrievedData = (new XMLSerializer()).serializeToString(retrievedData);
            //             var parsedRetrievedData = xmlToJson.parse(data);
            //             retrievedData = Object.entries(Object.entries(parsedRetrievedData)[0][1])[2][1];
            //             schemaLocation = Object.entries(Object.entries(parsedRetrievedData)[0][1])[1][1];

            //         }
            //         else if (contentType === 'json') {
            //             retrievedData = data;
            //             schemaLocation = xhr.getResponseHeader('Link');
            //         }
            //         //The tags that need to be retrieved.
            //         var keyNameArray = ['name', 'views', 'id', 'rating', 'episodes'];

            //         //Main logic of calling the functions.
            //         executeAnimeUsersStatsFunctions();
            //         async function executeAnimeUsersStatsFunctions() {
            //             await validation(retrievedData, await getSchema(schemaLocation));
            //             // await mainMenuTopAnimeChart(await convertJSONtoGraphData(retrievedData, keyNameArray));
            //         }
            //     },
            // })
        }
        //Gets the schema for the JSON or XML above.
        function getSchema(schemaLocation, ) {
            return ($.ajax({
                url: schemaLocation,
                type: 'GET',
                success: function (data) {
                    schema = data;
                },
            }))

        }

        //Validation of the retrieved data.
        function validation(retrievedData, schema) {
            if (contentType === 'json') {
                console.log(ajv.validate(schema, retrievedData));
                return retrievedData;
            }
            else if (contentType === 'xml') {
                console.log(xmllint.validateXML({ xml: retrievedData, schema: schema }).errors);
                if (!xmllint.validateXML({ xml: retrievedData, schema: schema }).errors) {
                    console.log("validated");
                    return retrievedData;
                }
            }
        }

        //Transforms retrieved data (JSON) into a single format other graphs can work with.
        function convertJSONtoGraphData(validatedDataInJSON, keyNameArray) {
            var dataTagsArray = [];
            $.each(validatedDataInJSON, function (k, i) {
                dataTagsArray[k] = i;
            });
            return dataTagsArray;
        }
    </script>
</body>

</html>