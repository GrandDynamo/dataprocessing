<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.css"
        integrity="sha256-IvM9nJf/b5l2RoebiFno92E5ONttVyaEEsdemDC6iQA=" crossorigin="anonymous" />
    <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.0/ajv.bundle.js"
        integrity="sha256-u9xr+ZJ5hmZtcwoxwW8oqA5+MIkBpIp3M2a4AgRNH1o=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.0/ajv.min.js"
        integrity="sha256-QZBaIVRF3ZHdyLzzW3WQQ5kVlqYeAgx4ccOv4ph/e/E=" crossorigin="anonymous"></script>
    <script src="libraries/xmlToJson-master/xmlToJson.js"></script>


    <title>Anime Statistics</title>
</head>

<body>
    <canvas id="myChart"></canvas>
    <canvas id="myChart2"></canvas>
    <!-- Random number generator, Used for testing -->
    <script>
        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
    </script>
    <!-- Main menu top anime Graph. -->
    <script>
        /**
         *
         * Main menu graph top anime graph.
         *
         */
        var ctx = document.getElementById("myChart").getContext('2d');

        var mainMenuTopAnimeNames = [];
        var mainMenuTopAnimeViews = [];
        var mainMenuTopAnimeIds = [];
        var mainMenuTopAnimeRatings = [];
        var mainMenuTopAnimeTotalEpisodes = [];

        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: mainMenuTopAnimeNames,
                datasets: [
                    // {
                    //     type: "line",
                    //     label: 'Rating',
                    //     fill: false,
                    //     backgroundColor: 'rgb(255, 99, 132)',
                    //     borderColor: 'rgb(255, 99, 132)',
                    //     data: mainMenuTopAnimeRatings,
                    //     yAxisID: 'right-y-axis',

                    // },
                    // {
                    //     type: "bar",
                    //     label: 'Male',
                    //     fill: false,
                    //     backgroundColor: 'rgb(255, 99, 132)',
                    //     borderColor: 'rgb(255, 99, 132)',
                    //     data: mainMenuTopAnimeTotalEpisodes,
                    //     xAxisID: 'views-x-axis',
                    //     yAxisID: 'views-y-axis',


                    // },

                    // {
                    //     label: 'Episodes',
                    //     data: mainMenuTopAnimeTotalEpisodes,
                    //     backgroundColor: 'rgba(107, 196, 255, 1)',
                    //     borderColor: 'rgba(0, 138, 230, 1)',
                    // },
                    {
                        label: 'Rating',
                        type: "line",
                        data: mainMenuTopAnimeRatings,

                        borderWidth: 2,
                        // maxBarThickness: 200,
                        // xAxisID: 'views-x-axis',
                        yAxisID: 'right-y-axis',
                        fill: false,
                        pointHoverRadius: 8,
                        pointRadius: 5,
                        backgroundColor: 'rgb(201, 22, 60)',
                        borderColor: 'rgb(255, 99, 132)',


                    },
                    {
                        label: 'Views',
                        data: mainMenuTopAnimeViews,
                        backgroundColor: 'rgba(50, 180, 227)',
                        borderColor: 'rgba(0, 138, 230, 1)',
                    },
                    {
                        label: 'animeId',
                        data: mainMenuTopAnimeIds,
                        hidden: true,

                    }
                ]
            },
            options: {
                legend: {
                    labels: {
                        filter: function (item, chart) {
                            // Remove legend item.
                            return !item.text.includes('animeId');
                        },

                    }
                },
                scales: {
                    xAxes: [{
                        stacked: true,
                        id: 'views-x-axis',
                        ticks: {
                            fontSize: 14,
                        }
                    }
                    ],
                    yAxes: [{
                        stacked: true,
                        id: 'views-y-axis',
                        type: 'linear',
                        position: 'left',
                        ticks: {
                            // suggestedMax: 10,
                            suggestedMin: 0,
                            stepSize: 100
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Views',
                            fontSize: 24,
                        },
                    }, {
                        type: 'linear',
                        id: 'right-y-axis',
                        display: true,
                        position: 'right',
                        stacked: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Rating',
                            fontSize: 28,
                        },
                        gridLines: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            suggestedMax: 10,
                            // suggestedMin: 9,
                            stepSize: 1
                        }
                    }]
                }
            },
        })
    </script>
    <!-- Scripts for getting the data. -->
    <script>
        var ajv = new Ajv({ coerceTypes: 'array' });
        /**
         * 
         * This section retrieves all json data from the API.
         * 
         *  
        */
        //Retrieve Top anime data
        getTopAnimeDataXMLTest();
        function getTopAnimeDataXMLTest() {
            $.ajax({
                url: "http://localhost/dataprocessing/api/v1/topanimes/10",
                type: 'GET',
                contentType: "application/xml",
                success: function (data, status, xhr) {
                    var retrievedData = xmlToJson.parse(data);
                    console.log(JSON.stringify(retrievedData['root'].anime));
                    // var schemaLocation = xhr.getResponseHeader('Link');
                    var schemaLocation = "http://localhost/dataprocessing/server/api/v1/schemas/draft-07/getTopWatchedAnime.json";
                    var keyNameArray = ['name', 'views', 'id', 'rating', 'episodes'];
                    // console.log(JSON.stringify(data));

                    getSchemaXMLTest(retrievedData, keyNameArray, schemaLocation);
                },
            })
        }
        //Gets the schema for the JSON or XML above.
        function getSchemaXMLTest(retrievedData, keyNameArray, schemaLocation, ) {
            $.ajax({
                url: schemaLocation,
                type: 'POST',
                success: function (data) {
                    schema = data;
                    validation(retrievedData, keyNameArray, schema);
                },
            })
        }


        //Retrieve Top anime data
        // getTopAnimeData();
        // function getTopAnimeData() {
        //     $.ajax({
        //         url: "http://localhost/dataprocessing/api/v1/topanimes/10",
        //         type: 'GET',
        //         contentType: "application/json",
        //         success: function (data, status, xhr) {
        //             var retrievedData = data;
        //             var schemaLocation = xhr.getResponseHeader('Link');
        //             var keyNameArray = ['name', 'views', 'id', 'rating', 'episodes'];
        //             console.log(JSON.stringify(data));
        //             getSchema(retrievedData, keyNameArray, schemaLocation);
        //         },
        //     })
        // }
        // //Gets the schema for the JSON or XML above.
        // function getSchema(retrievedData, keyNameArray, schemaLocation, ) {
        //     $.ajax({
        //         url: schemaLocation,
        //         type: 'POST',
        //         success: function (data) {
        //             schema = data;
        //             validation(retrievedData, keyNameArray, schema);
        //         },
        //     })
        // }

        function addDataToBarGraph(json) {
            //The delay between two iterations in milliseconds.
            var interval = 100;
            //Gives effect of graph creation.
            var promise = Promise.resolve();
            $.each(json, function (k, i, o) {
                promise = promise.then(function () {
                    // console.log(i['id']);
                    // console.log("Name: " + i['name']);
                    // console.log("Views: " + i['views']);
                    // console.log("Rating: " + i['rating']);
                    // console.log("Episodes: " + i['episodes']);
                    // console.log("ID: " + i['id']);
                    mainMenuTopAnimeNames.push(i['name']);
                    mainMenuTopAnimeViews.push(i['views']);
                    mainMenuTopAnimeIds.push(i['id']);
                    mainMenuTopAnimeRatings.push(i['rating']);
                    mainMenuTopAnimeTotalEpisodes.push(i['episodes']);
                    myChart.update();
                    return new Promise(function (resolve) {
                        setTimeout(resolve, interval);
                    });
                });
            });
            promise.then(function () {
                console.log('Loop finished.');
            });
        }

        //Validation
        function validation(retrievedData, keyNameArray, schema) {
            console.log(ajv.validate(schema, retrievedData));
            addDataToBarGraph(retrievedData);
        }

        function validateJSON(json, schema) {
            // console.log(JSON.stringify(json));
            console.log(ajv.validate(schema, json));
            addDataToBarGraph(json);
            // console.log(data);

        }

    </script>
    <!-- Click event handler for main top anime chart. -->
    <script>
        /**
         * 
         * Click event handler main top anime chart.
         * 
         */
        document.getElementById("myChart").onclick = function (evt) {
            var activePoints = myChart.getElementsAtEventForMode(evt, 'point', myChart.options);
            var firstPoint = activePoints[0];
            //Check of click wel op een bar was.
            if (firstPoint == undefined) { return; }

            var label = myChart.data.labels[firstPoint._index];
            var value = myChart.data.datasets[firstPoint._datasetIndex].data[firstPoint._index];
            console.log("Label: " + label + ": " + value);
            // console.log(myChart.data.datasets[firstPoint._datasetIndex]);
            // console.log(myChart.data.datasets);
            // console.log(activePoints[0]._index);
            console.log(myChart.data.datasets[2].data[activePoints[0]._index]);
            console.log(activePoints[0]._index);
        };
    </script>
    <!-- Anime specific statistics -->
    <script>

    </script>
    <script>
        /**
         *
         * Script for the Anime data.
         *
         *
         */

    </script>
    <script>

    </script>
</body>

</html>